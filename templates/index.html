<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fake Email Detector</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- pdf.js Library (for PDF parsing) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <!-- pdf.js worker -->
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';</script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Page Icon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
</head>

<!-- The <body> tag has the "light-mode" class by default -->
<body class="light-mode">

    <!-- Header Section -->
    <header class="header-container">
        <h1 class="header-title">
            <span class="header-icon">üõ°Ô∏è</span>
            Fake Email Detector
        </h1>
        <div class="theme-toggle-container">
            <span class="theme-label">Light Mode</span>
            <button id="theme-toggle" class="theme-toggle-button">
                <!-- Sun icon -->
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12h2.25m.386-6.364l1.591 1.591" />
                </svg>
                <!-- Moon icon -->
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                </svg>
            </button>
            <span class="theme-label">Dark Mode</span>
        </div>
    </header>

    <!-- Main Content Grid -->
    <main class="main-grid">

        <!-- Left Column (Info) -->
        <div class="info-column">
            <h2 class="info-title">Fake Email Checker - Try It Free</h2>
            <p class="info-text">
                Accepted formats: <strong>.TXT files only</strong> for analysis.
            </p>
            <p class="info-text">
                Detect fake emails by uploading a .txt file. Our AI model analyzes the text for signs of phishing, urgency, and suspicious patterns to verify email authenticity.
            </p>
            <p class="info-text">
                This tool helps you get a snapshot of an email's health so you can protect your personal information and prevent security breaches.
            </p>
            <h3 class="info-access-title">
                Use the tool on the right to check your emails now!
            </h3>
        </div>

        <!-- Right Column (The App) -->
        <div class="app-column">
            <div class="app-card">
                <h3 class="app-title">1. Upload your .txt file for Analysis</h3>

                <!-- .TXT File Input Area -->
                <div class="file-input-wrapper">
                    <input type="file" id="txt-file-input" class="file-input-hidden" accept=".txt">
                    <label for="txt-file-input" class="file-input-label">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        Choose .TXT File
                    </label>
                    <span id="txt-file-name" class="file-name-display">No .txt file selected...</span>
                </div>

                <!-- Verify Button -->
                <button id="analyze-button" class="app-button">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.623 0-1.662-.36-3.223-.985-4.635A11.959 11.959 0 0112 2.714z" />
                    </svg>
                    Verify .TXT File
                </button>

                <!-- Loading Spinner (Hidden by default) -->
                <div id="loading-spinner" class="loading-spinner" style="display: none;">
                    <div></div><div></div><div></div><div></div>
                </div>

                <!-- Result Box (Hidden by default) -->
                <div id="result-box" class="result-box" style="display: none;">
                    <h3 id="result-title" class="result-title"></h3>
                    <p id="result-confidence" class="result-confidence"></p>
                </div>
            </div>

            <!-- PDF Converter Section -->
            <div class="app-card pdf-converter-card">
                 <h3 class="app-title">2. Got a PDF? Convert it to TXT</h3>
                 <p class="pdf-converter-text">
                     Have the email as a PDF file? No worries! Convert it to a .txt file here, then upload the .txt file above.
                 </p>
                 <div class="file-input-wrapper pdf-input-wrapper">
                    <input type="file" id="pdf-file-input" class="file-input-hidden" accept=".pdf">
                    <label for="pdf-file-input" class="file-input-label pdf-input-label">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25M9 19.5l3-3m0 0l3 3m-3-3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        Choose .PDF File
                    </label>
                    <span id="pdf-file-name" class="file-name-display">No .pdf file selected...</span>
                 </div>
                 <button id="convert-button" class="app-button pdf-convert-button" disabled>
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
                     </svg>
                     Convert PDF to TXT
                 </button>
                 <div id="pdf-status" class="pdf-status-text"></div>
            </div>

        </div>
    </main>

    <!-- "How it Works" Section (Scroll to) -->
    <section class="how-it-works-section">
        <h2 class="how-it-works-title">How This Is Working</h2>
        <div class="how-it-works-grid">

            <div class="how-it-works-card">
                <h3>1. The Frontend (This Webpage)</h3>
                <p>You upload a .txt file OR convert a .pdf to .txt here. The JavaScript reads the text and sends *only the text* to the backend server for analysis.</p>
            </div>

            <div class="how-it-works-card">
                <h3>2. The Backend (The Server)</h3>
                <p>A Python server (Flask) receives the text. It doesn't know if it came from a .txt or a converted .pdf. It passes the text to the AI model.</p>
            </div>

            <div class="how-it-works-card">
                <h3>3. The AI Model (The Brain)</h3>
                <p>Our custom-trained DistilBERT AI analyzes the text for phishing patterns and sends back the prediction (Legitimate or Phishing Risk).</p>
            </div>

        </div>
    </section>

    <!-- Custom CSS (in <style> tags as requested) -->
    <style>
        /* =================================
           1. ROOT CSS VARIABLES (THE THEME)
           =================================
        */
        :root {
            --bg-color: #f0f4f8; /* Light gray-blue */
            --text-color: #334155; /* Dark slate */
            --card-bg-color: #ffffff; /* White */
            --accent-color: #0d9488; /* Teal */
            --accent-text-color: #ffffff;
            --border-color: #e2e8f0; /* Light border */
            --header-bg-color: #ffffff;
            --how-it-works-bg-color: #ffffff;
            --secondary-accent-color: #5eead4; /* Lighter Teal for PDF button */
            --secondary-accent-text-color: #0f766e; /* Darker Teal for PDF text */
            --status-text-color: #64748b; /* Slate for status */
        }
        .dark-mode {
            --bg-color: #0f172a; /* Dark navy */
            --text-color: #cbd5e1; /* Light slate */
            --card-bg-color: #1e293b; /* Darker card */
            --accent-color: #2dd4bf; /* Bright teal */
            --accent-text-color: #0f172a;
            --border-color: #334155; /* Dark border */
            --header-bg-color: #1e293b;
            --how-it-works-bg-color: #1e293b;
            --secondary-accent-color: #0d9488; /* Darker Teal for PDF button */
            --secondary-accent-text-color: #ccfbf1; /* Very Light Teal for PDF text */
            --status-text-color: #94a3b8; /* Lighter Slate for status */
        }
        /* ... (Keep ALL other CSS rules from the previous style.css file here) ... */
        body { background-color: var(--bg-color); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; transition: background-color 0.3s ease, color 0.3s ease; margin: 0; padding: 0; }
        .header-container { background-color: var(--header-bg-color); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); transition: background-color 0.3s ease, border-color 0.3s ease; }
        .header-title { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; color: var(--text-color); }
        .header-icon { font-size: 1.75rem; margin-right: 0.5rem; }
        .theme-toggle-container { display: flex; align-items: center; gap: 0.75rem; }
        .theme-label { font-size: 0.875rem; font-weight: 500; color: var(--text-color); }
        .theme-toggle-button { width: 3.5rem; height: 1.75rem; background-color: #e2e8f0; border-radius: 9999px; position: relative; padding: 0; border: none; cursor: pointer; transition: background-color 0.3s ease; }
        .dark-mode .theme-toggle-button { background-color: #334155; }
        .theme-toggle-button::before { content: ''; position: absolute; top: 0.25rem; left: 0.25rem; width: 1.25rem; height: 1.25rem; background-color: white; border-radius: 50%; transition: transform 0.3s ease; }
        .dark-mode .theme-toggle-button::before { transform: translateX(1.75rem); background-color: #e2e8f0; }
        .theme-toggle-button svg { position: absolute; top: 0.375rem; width: 1rem; height: 1rem; color: #f59e0b; }
        .theme-toggle-button #sun-icon { left: 0.5rem; }
        .theme-toggle-button #moon-icon { right: 0.5rem; color: #38bdf8; }
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; padding: 2rem; max-width: 1200px; margin: 0 auto; }
        @media (min-width: 1024px) { .main-grid { grid-template-columns: 1fr 1fr; } }
        .info-column { padding: 1rem; }
        .info-title { font-size: 2.25rem; font-weight: 800; color: var(--text-color); margin-bottom: 1rem; }
        .info-text { font-size: 1rem; color: var(--text-color); line-height: 1.6; margin-bottom: 1rem; }
        .info-access-title { font-size: 1.25rem; font-weight: 700; color: var(--accent-color); margin-top: 2rem; }
        .app-column { display: flex; flex-direction: column; /* Stack cards vertically */ align-items: center; justify-content: flex-start; /* Align cards to top */ gap: 2rem; /* Add space between cards */ }
        .app-card { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 2rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); width: 100%; max-width: 500px; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .app-title { font-size: 1.125rem; font-weight: 600; color: var(--text-color); margin-bottom: 1.5rem; text-align: center; }
        .file-input-wrapper { position: relative; width: 100%; display: flex; flex-direction: column; align-items: center; border: 2px dashed var(--border-color); border-radius: 0.5rem; padding: 1.5rem; transition: border-color 0.3s ease; margin-bottom: 1.5rem; /* Add margin below file input */ }
        .file-input-hidden { width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; position: absolute; z-index: -1; }
        .file-input-label { background-color: var(--accent-color); color: var(--accent-text-color); padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; transition: background-color 0.3s ease; }
        .file-input-label:hover { filter: brightness(110%); }
        .file-name-display { margin-top: 1rem; font-size: 0.875rem; color: var(--text-color); text-align: center; word-break: break-all; }
        .app-button { width: 100%; background-color: var(--accent-color); color: var(--accent-text-color); font-size: 1rem; font-weight: 600; padding: 0.75rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-top: 0; /* Remove top margin */ transition: background-color 0.3s ease; }
        .app-button:hover { filter: brightness(110%); }
        .app-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .result-box { margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem; text-align: center; }
        .result-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
        .result-confidence { font-size: 1rem; font-weight: 500; }
        .result-phishing { background-color: #fee2e2; border: 1px solid #f87171; }
        .result-phishing .result-title { color: #dc2626; }
        .result-phishing .result-confidence { color: #ef4444; }
        .result-legitimate { background-color: #dcfce7; border: 1px solid #4ade80; }
        .result-legitimate .result-title { color: #16a34a; }
        .result-legitimate .result-confidence { color: #22c55e; }
        .dark-mode .result-phishing { background-color: #450a0a; border-color: #ef4444; }
        .dark-mode .result-phishing .result-title { color: #f87171; }
        .dark-mode .result-phishing .result-confidence { color: #fca5a5; }
        .dark-mode .result-legitimate { background-color: #052e16; border-color: #4ade80; }
        .dark-mode .result-legitimate .result-title { color: #86efac; }
        .dark-mode .result-legitimate .result-confidence { color: #bbf7d0; }
        .loading-spinner { display: inline-block; position: relative; width: 80px; height: 80px; margin: 1rem auto 0; }
        .loading-spinner div { box-sizing: border-box; display: block; position: absolute; width: 64px; height: 64px; margin: 8px; border: 8px solid var(--accent-color); border-radius: 50%; animation: loading-spinner 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; border-color: var(--accent-color) transparent transparent transparent; }
        .loading-spinner div:nth-child(1) { animation-delay: -0.45s; }
        .loading-spinner div:nth-child(2) { animation-delay: -0.3s; }
        .loading-spinner div:nth-child(3) { animation-delay: -0.15s; }
        @keyframes loading-spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .how-it-works-section { padding: 3rem 2rem; background-color: var(--how-it-works-bg-color); border-top: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease; }
        .how-it-works-title { font-size: 2rem; font-weight: 700; text-align: center; margin-bottom: 2rem; color: var(--text-color); }
        .how-it-works-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; max-width: 1200px; margin: 0 auto; }
        @media (min-width: 768px) { .how-it-works-grid { grid-template-columns: repeat(3, 1fr); } }
        .how-it-works-card { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .how-it-works-card h3 { font-size: 1.25rem; font-weight: 600; color: var(--accent-color); margin-bottom: 0.75rem; }
        .how-it-works-card p { font-size: 1rem; line-height: 1.6; color: var(--text-color); }

        /* --- PDF CONVERTER SPECIFIC STYLES --- */
        .pdf-converter-card {
            margin-top: 2rem; /* Add space above the converter card */
        }
        .pdf-converter-text {
            font-size: 0.9rem;
            color: var(--status-text-color); /* Use a softer color */
            margin-bottom: 1.5rem;
            text-align: center;
            line-height: 1.5;
        }
        .pdf-input-wrapper {
             /* Inherits styles from .file-input-wrapper */
             margin-bottom: 1.5rem; /* Space below PDF input */
        }
        .pdf-input-label {
             /* Different color for PDF button */
            background-color: var(--secondary-accent-color);
            color: var(--secondary-accent-text-color);
        }
        .pdf-convert-button {
            /* Inherits from .app-button */
            margin-top: 0; /* No top margin needed after input wrapper */
        }
         .pdf-status-text {
            margin-top: 1rem;
            font-size: 0.875rem;
            color: var(--status-text-color);
            text-align: center;
            min-height: 1.25rem; /* Reserve space */
        }

    </style>

    <!-- Custom JavaScript -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            // --- Theme Toggle Logic ---
            const themeToggleButton = document.getElementById("theme-toggle");
            const sunIcon = document.getElementById("sun-icon");
            const moonIcon = document.getElementById("moon-icon");
            if (localStorage.getItem("theme") === "dark") {
                document.body.classList.add("dark-mode");
                sunIcon.classList.add("hidden");
                moonIcon.classList.remove("hidden");
            }
            themeToggleButton.addEventListener("click", () => {
                document.body.classList.toggle("dark-mode");
                const isDarkMode = document.body.classList.contains("dark-mode");
                localStorage.setItem("theme", isDarkMode ? "dark" : "light");
                sunIcon.classList.toggle("hidden", isDarkMode);
                moonIcon.classList.toggle("hidden", !isDarkMode);
            });

            // --- Elements for AI Analysis ---
            const analyzeButton = document.getElementById("analyze-button");
            const txtFileInput = document.getElementById("txt-file-input");
            const txtFileNameDisplay = document.getElementById("txt-file-name");
            const loadingSpinner = document.getElementById("loading-spinner");
            const resultBox = document.getElementById("result-box");
            const resultTitle = document.getElementById("result-title");
            const resultConfidence = document.getElementById("result-confidence");

            // --- Elements for PDF Conversion ---
            const pdfFileInput = document.getElementById("pdf-file-input");
            const pdfFileNameDisplay = document.getElementById("pdf-file-name");
            const convertButton = document.getElementById("convert-button");
            const pdfStatus = document.getElementById("pdf-status");

            // --- Helper Functions ---
            function showError(message, target = 'main') {
                 if (target === 'pdf') {
                    pdfStatus.textContent = `Error: ${message}`;
                    pdfStatus.style.color = 'var(--result-phishing .result-title)'; // Use error color
                 } else {
                    resultBox.style.display = "block";
                    resultBox.classList.remove("result-legitimate");
                    resultBox.classList.add("result-phishing"); // Use phishing style for errors
                    resultTitle.innerText = "Error";
                    resultConfidence.innerText = message;
                 }
            }

            function showPdfStatus(message) {
                 pdfStatus.textContent = message;
                 pdfStatus.style.color = 'var(--status-text-color)'; // Reset to default status color
            }

            // --- .TXT File Input Logic ---
            txtFileInput.addEventListener("change", () => {
                if (txtFileInput.files.length > 0) {
                    txtFileNameDisplay.textContent = txtFileInput.files[0].name;
                } else {
                    txtFileNameDisplay.textContent = "No .txt file selected...";
                }
                 // Clear previous results when a new file is chosen
                 resultBox.style.display = "none";
            });

             // --- .PDF File Input Logic ---
             pdfFileInput.addEventListener("change", () => {
                if (pdfFileInput.files.length > 0) {
                    const file = pdfFileInput.files[0];
                    if (file.type === "application/pdf") {
                        pdfFileNameDisplay.textContent = file.name;
                        convertButton.disabled = false; // Enable convert button
                        showPdfStatus(''); // Clear status
                    } else {
                         pdfFileNameDisplay.textContent = "Not a PDF file!";
                         convertButton.disabled = true; // Keep disabled
                         showError("Please select a .pdf file.", 'pdf');
                         pdfFileInput.value = ''; // Reset input
                    }
                } else {
                    pdfFileNameDisplay.textContent = "No .pdf file selected...";
                    convertButton.disabled = true; // Disable if no file
                    showPdfStatus(''); // Clear status
                }
            });


            // --- Analyze .TXT Button Click Logic ---
            analyzeButton.addEventListener("click", () => {
                const file = txtFileInput.files[0];

                if (!file) {
                    showError("Please choose a .txt file to analyze.");
                    return;
                }
                if (file.type !== "text/plain") {
                    showError("Invalid file type. Please upload a .txt file.");
                    return;
                }

                loadingSpinner.style.display = "block";
                resultBox.style.display = "none";
                analyzeButton.disabled = true;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    console.log("Sending text to /predict:", text.substring(0, 50) + "...");

                    fetch("/predict", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ text: text }),
                    })
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                        return response.json();
                     })
                    .then(data => {
                        loadingSpinner.style.display = "none";
                        analyzeButton.disabled = false;
                        resultBox.style.display = "block";
                        resultBox.classList.remove("result-phishing", "result-legitimate");
                        if (data.prediction === "Phishing") {
                            resultTitle.innerText = "Phishing Risk";
                            resultBox.classList.add("result-phishing");
                        } else {
                            resultTitle.innerText = "Legitimate";
                            resultBox.classList.add("result-legitimate");
                        }
                        resultConfidence.innerText = `Confidence: ${(data.confidence * 100).toFixed(2)}%`;
                    })
                    .catch(error => {
                        loadingSpinner.style.display = "none";
                        analyzeButton.disabled = false;
                        showError("Could not connect to the server or process the request.");
                        console.error("Fetch Error:", error);
                    });
                };
                reader.onerror = () => {
                    loadingSpinner.style.display = "none";
                    analyzeButton.disabled = false;
                    showError("Could not read the .txt file.");
                    console.error("File reading error");
                };
                reader.readAsText(file);
            });

             // --- Convert PDF Button Click Logic ---
             convertButton.addEventListener("click", async () => {
                const file = pdfFileInput.files[0];
                if (!file) return; // Should be disabled if no file

                convertButton.disabled = true;
                showPdfStatus("Converting PDF... please wait.");

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = '';

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n\n'; // Add newline between pages
                    }

                    // Create a blob with the text
                    const blob = new Blob([fullText], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);

                    // Create a download link
                    const a = document.createElement('a');
                    a.href = url;
                    // Suggest a filename based on the original PDF name
                    const txtFilename = file.name.replace(/\.pdf$/i, '.txt');
                    a.download = txtFilename;
                    document.body.appendChild(a);
                    a.click();

                    // Clean up
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    showPdfStatus(`Conversion successful! '${txtFilename}' downloaded.`);
                    // Optionally reset the PDF input
                    // pdfFileInput.value = '';
                    // pdfFileNameDisplay.textContent = 'No .pdf file selected...';

                } catch (error) {
                    showError("Failed to convert PDF. It might be corrupted or password-protected.", 'pdf');
                    console.error("PDF Conversion Error:", error);
                } finally {
                     // Re-enable button after operation (even on error)
                     // Keep it disabled if no file is selected anymore
                    if (pdfFileInput.files.length > 0) {
                        convertButton.disabled = false;
                    }
                }
            });

        });
    </script>
</body>
</html>

